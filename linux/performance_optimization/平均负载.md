# 平均负载

### 定义
系统的平均负载是指单位时间内，处于**可运行状态**和**不可中断状态**的**平均进程数**，即单位时间内的平均活跃进程数（实际是活跃进程数的指数衰减平均值）。

所谓可运行状态的进程，是指正在使用CPU或者正在等待CPU的进程，也就是我们常用ps命令看到的，处于R状态（Running 或 Runnable）的进程。

不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的I/O响应，也就是我们在ps命令中看到的D状态（Uninterruptible Sleep，也称为Disk Sleep）的进程。

### 查看
    $ uptime
    23:23  up 26 days,  6:34, 2 users, load averages: 2.14 2.10 2.12
    # 各列分别是：当前时间、系统运行时间、正在登录用户数、过去1分钟、5分钟、15分钟的平均负载
   
### 负载大小
平均负载的大小判断需基于平均负载和cpu个数的比值.理想情况下，每个cpu刚好运行一个进程，可充分使用硬件性能。当负载大于cpu个数时，就出现过载问题。

    # 查看cpu数量：
    $ grep 'model name' /proc/cpuinfo | wc -l
      2 
    
从uptime可查看到3个负载数据，它提供了负载变化趋势的信息，有助于更全面的了解和分析问题。

### 平均负载和cpu使用率
平均负载容易跟cpu使用率混淆，其实它们并不是一一对应的。从平均负载的定义来看，导致负载变化的进程有三种情况：

1）正在使用cpu；
2）等待分配cpu；
3）等待io响应。

因此，我们需要分以下几种情况来区分：

* cpu密集型进程：大量使用cpu会导致负载升高，cpu使用率也升高，此时两者一致；
* io密集型进程：大量io等待进程会导致负载升高，但cpu使用率并不高；
* 大量等待分配cpu的进程会导致负载升高，此时cpu的使用率也比较高。

### 实战分析

环境：虚拟机（Ubuntu 18.04）

使用工具包：stress和sysstat。其中sysstat常用的命令有：

    mpstat：是一个常用的多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，以及所有CPU的平均指标。
    pidstat：是一个常用的进程性能分析工具，用来实时查看进程的 CPU、内存、I/O 以及上下文切换等性能指标。

场景模拟前的负载情况：

    23:41:32 up 47 min,  4 users,  load average: 0.00, 0.14, 0.52

场景一：cpu密集型进程（启动3个终端分别做以下操作）

1、模拟一个cpu使用率100%的情况：

    $ stress --cpu 1 --timeout 600

2、看到负载慢慢升到1左右：

    $ watch -d uptime   # -d 是高亮变化区域
    23:50:36 up 56 min,  4 users,  load average: 1.01, 0.78, 0.65
    
3、运行mpstat查看 CPU 使用率的变化情况：

    $ mpstat -P ALL 5   # -P ALL监控所有CPU，5代表每5秒输出一组数据
    Linux 5.4.0-42-generic (lyr-study)   2021年01月08日   _x86_64_  (2 CPU)

    23时44分20秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    23时44分25秒  all   50.20    0.00    0.40    0.00    0.00    0.00    0.00    0.00    0.00   49.40
    23时44分25秒    0  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
    23时44分25秒    1    0.20    0.00    1.00    0.20    0.00    0.00    0.00    0.00    0.00   98.60
    
    看到一个cpu的使用率为100%（%usr）。
    
4、用pidstat分析：

    $ pidstat -u 5 1    # 间隔5秒输出一组数据
    
    23时51分29秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    23时51分34秒     0     31278    0.00    0.20    0.00    0.00    0.20     1  kworker/1:5-mm_percpu_wq
    23时51分34秒     0     62662  100.00    0.00    0.00    0.00  100.00     1  stress
    23时51分34秒     0     62663    0.20    0.40    0.00    0.00    0.60     0  pidstat
    
    明显发现stress进程的cpu使用率为100%。


场景二：io密集型进程

1、模拟io压力，不断地sync：
    
    stress -i 1 --timeout 600

2、查看负载变化情况：

    $ watch -d uptime
    00:14:34 up  1:20,  4 users,  load average: 1.18, 0.71, 0.44
    
3、运行mpstat查看 CPU 使用率的变化情况：

    $ mpstat -P ALL 5
    Linux 5.4.0-42-generic (lyr-study)   2021年01月08日   _x86_64_  (2 CPU)
    
    00时13分46秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    00时13分51秒  all    1.70    0.00   48.90    0.00    0.00    0.00    0.00    0.00    0.00   49.40
    00时13分51秒    0    0.20    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   98.80
    00时13分51秒    1    3.19    0.00   96.81    0.00    0.00    0.00    0.00    0.00    0.00    0.00

    发现某个CPU的%sys使用率接近100%（有资料显示此场景%iowait会很高，但我这个环境下并没有）。
    
4、用pidstat分析：

    $ pidstat -u 5 1
    Linux 5.4.0-42-generic (lyr-study)   2021年01月08日   _x86_64_  (2 CPU)
    
    00时15分38秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    00时15分43秒   121      1449    0.00    0.20    0.00    0.00    0.20     0  gsd-color
    00时15分43秒     0     31278    0.00    0.20    0.00    0.00    0.20     1  kworker/1:5-events
    00时15分43秒     0     63297    2.19   97.61    0.00    0.00   99.80     0  stress
    00时15分43秒     0     63298    0.20    0.40    0.00    0.00    0.60     1  pidstat
    
    明显发现导致%sys使用率升高的是stress进程。
    
场景三：大量进程

1、模拟多进程：

    stress -c 8 --timeout 600
    
2、查看负载

    $ watch -d uptime
    00:19:16 up  1:24,  4 users,  load average: 7.51, 3.70, 1.65
    
    可见负载高达7.51。
    
3、用pidstat分析：

    $ pidstat -u 5 1
    Linux 5.4.0-42-generic (lyr-study)   2021年01月08日   _x86_64_  (2 CPU)
    
    00时19分01秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    00时19分06秒     0     63306   24.65    0.00    0.00   75.15   24.65     0  stress
    00时19分06秒     0     63307   24.65    0.00    0.00   75.55   24.65     0  stress
    00时19分06秒     0     63308   24.65    0.00    0.00   74.75   24.65     0  stress
    00时19分06秒     0     63309   24.85    0.00    0.00   74.95   24.85     1  stress
    00时19分06秒     0     63310   25.05    0.00    0.00   74.95   25.05     1  stress
    00时19分06秒     0     63311   24.65    0.00    0.00   75.35   24.65     0  stress
    00时19分06秒     0     63312   25.05    0.00    0.00   74.95   25.05     1  stress
    00时19分06秒     0     63313   25.05    0.00    0.00   75.15   25.05     1  stress
    00时19分06秒     0     63314    0.20    0.40    0.00    0.20    0.60     0  watch
    00时19分06秒     0     63522    0.00    0.60    0.00    0.20    0.60     0  pidstat
    
    stress进程的%wait很大。
    